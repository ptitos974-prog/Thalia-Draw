<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thalia Draw</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .main-grid { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card-title { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; color: #667eea; }
        .ai-panel { display: flex; flex-direction: column; gap: 15px; }
        .input-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; padding: 10px; border: 2px solid #667eea; background: white;
            color: #667eea; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: bold;
        }
        .tab-btn.active { background: #667eea; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; resize: vertical; font-family: inherit; font-size: 14px;
        }
        .voice-btn, .photo-btn {
            width: 100%; padding: 15px; border: 2px dashed #667eea;
            background: #f3f4ff; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;
        }
        .voice-btn:hover, .photo-btn:hover { background: #667eea; color: white; }
        .voice-btn.recording { background: #ef4444; color: white; border-color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .generate-btn {
            width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold;
            cursor: pointer; transition: transform 0.2s;
        }
        .generate-btn:hover { transform: translateY(-2px); }
        .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .api-status { padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9em; }
        .api-status.connected { background: #d1fae5; color: #065f46; }
        .api-status.disconnected { background: #fee2e2; color: #991b1b; }
        .config-btn {
            width: 100%; padding: 10px; background: #f3f4f6; border: 2px solid #d1d5db;
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .config-btn:hover { background: #e5e7eb; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .tool-btn {
            padding: 10px 15px; border: 2px solid #e0e0e0; background: white;
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .tool-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .color-picker { display: flex; gap: 5px; }
        .color-btn {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd;
            cursor: pointer; transition: transform 0.2s;
        }
        .color-btn:hover { transform: scale(1.2); }
        .color-btn.active { border: 3px solid #667eea; box-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
        #drawCanvas {
            border: 3px solid #e0e0e0; border-radius: 10px; cursor: crosshair;
            background: white; max-width: 100%; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .gallery { max-height: 700px; overflow-y: auto; }
        .gallery-item {
            margin-bottom: 15px; border: 2px solid #e0e0e0; border-radius: 10px;
            overflow: hidden; transition: all 0.3s;
        }
        .gallery-item:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .gallery-img { width: 100%; height: 150px; object-fit: cover; }
        .gallery-info { padding: 10px; background: #f9fafb; }
        .gallery-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .delete-btn { padding: 5px 10px; background: #fee2e2; color: #991b1b; border: none; border-radius: 5px; cursor: pointer; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .close-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: #999; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #374151; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .btn-primary { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .loading { text-align: center; padding: 20px; color: #667eea; }
        .spinner {
            border: 3px solid #f3f4f6; border-top: 3px solid #667eea; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="file"] { display: none; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® Thalia Draw</h1>
            <p>Cr√©ez votre histoire avec l'IA</p>
        </div>

        <div class="main-grid">
            <div class="card">
                <div class="card-title">ü§ñ G√©n√©ration IA</div>
                <div class="api-status" id="apiStatus">‚ö†Ô∏è API non configur√©e</div>
                <button class="config-btn" onclick="openModal()">‚öôÔ∏è Configurer l'API</button>
                <div class="ai-panel">
                    <div class="input-tabs">
                        <button class="tab-btn active" onclick="switchTab('text')">üìù Texte</button>
                        <button class="tab-btn" onclick="switchTab('voice')">üé§ Vocal</button>
                        <button class="tab-btn" onclick="switchTab('photo')">üì∑ Photo</button>
                    </div>
                    <div class="tab-content active" id="textTab">
                        <textarea id="textInput" rows="6" placeholder="D√©crivez votre dessin..."></textarea>
                    </div>
                    <div class="tab-content" id="voiceTab">
                        <div class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§ Cliquez pour parler</div>
                        <div id="voiceText" style="margin-top:10px;padding:10px;background:#f3f4ff;border-radius:8px;min-height:60px;"></div>
                    </div>
                    <div class="tab-content" id="photoTab">
                        <input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(event)">
                        <div class="photo-btn" onclick="document.getElementById('photoInput').click()">üì∑ T√©l√©charger une photo</div>
                        <div id="photoPreview"></div>
                    </div>
                    <button class="generate-btn" onclick="generate()" id="generateBtn">‚ú® G√©n√©rer le dessin</button>
                    <div id="loadingIndicator" class="loading" style="display:none;">
                        <div class="spinner"></div>
                        <p>G√©n√©ration en cours...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üé® Canvas</div>
                <div class="toolbar">
                    <button class="tool-btn active" onclick="selectTool('pen')">‚úèÔ∏è Crayon</button>
                    <button class="tool-btn" onclick="selectTool('eraser')">üßπ Gomme</button>
                    <div class="color-picker" id="colorPicker"></div>
                    <input type="range" min="1" max="20" value="3" id="lineWidth">
                    <button class="tool-btn" onclick="clearCanvas()">üóëÔ∏è Effacer</button>
                    <button class="tool-btn" onclick="saveDrawing()">üíæ Sauvegarder</button>
                    <button class="tool-btn" onclick="download()">‚¨áÔ∏è T√©l√©charger</button>
                </div>
                <canvas id="drawCanvas" width="800" height="600"></canvas>
            </div>

            <div class="card">
                <div class="card-title">üñºÔ∏è Ma Galerie</div>
                <div class="gallery" id="gallery"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîë Configuration API</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="alert alert-info">
                <strong>üìñ Comment obtenir votre cl√© API :</strong><br>
                1. Cr√©ez un compte sur <a href="https://www.perplexity.ai/settings/api" target="_blank" style="color:#1e40af;font-weight:bold;">Perplexity AI</a><br>
                2. Acc√©dez aux param√®tres API<br>
                3. G√©n√©rez une nouvelle cl√© API<br>
                4. Copiez et collez-la ci-dessous
            </div>
            <div class="form-group">
                <label>Cl√© API Perplexity</label>
                <input type="password" id="apiKeyInput" placeholder="pplx-xxxxxxxxxxxxx">
            </div>
            <button class="btn-primary" onclick="saveKey()">üíæ Enregistrer</button>
        </div>
    </div>

    <script>
        let canvas, ctx, isDrawing = false, currentTool = 'pen', currentColor = '#000000';
        let lineWidth = 3, drawings = [], apiKey = '', currentTab = 'text';
        let mediaRecorder, audioChunks = [], uploadedPhoto = null;
        const colors = ['#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#A020F0', '#FFFFFF'];

        window.onload = function() {
            canvas = document.getElementById('drawCanvas');
            ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            apiKey = localStorage.getItem('perplexityApiKey') || '';
            updateStatus();
            const picker = document.getElementById('colorPicker');
            colors.forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'color-btn';
                btn.style.backgroundColor = c;
                if (c === '#FFFFFF') btn.style.border = '2px solid #999';
                if (c === currentColor) btn.classList.add('active');
                btn.onclick = () => selectColor(c);
                picker.appendChild(btn);
            });
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseleave', stopDraw);
            loadGallery();
        };

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.strokeStyle = currentTool === 'eraser' ? '#FFFFFF' : currentColor;
            ctx.lineWidth = currentTool === 'eraser' ? lineWidth * 3 : lineWidth;
            ctx.stroke();
        }

        function stopDraw() { isDrawing = false; }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        document.getElementById('lineWidth').oninput = (e) => { lineWidth = e.target.value; };

        function clearCanvas() {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        async function toggleVoice() {
            const btn = document.getElementById('voiceBtn');
            const txt = document.getElementById('voiceText');
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = (e) => { audioChunks.push(e.data); };
                    mediaRecorder.onstop = () => {
                        txt.textContent = 'üéµ Audio enregistr√©';
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                    btn.classList.add('recording');
                    btn.textContent = '‚èπÔ∏è Arr√™ter';
                    txt.textContent = 'üé§ Enregistrement...';
                } catch (err) {
                    alert('Erreur micro: ' + err.message);
                }
            } else {
                mediaRecorder.stop();
                btn.classList.remove('recording');
                btn.textContent = 'üé§ Cliquez pour parler';
            }
        }

        function handlePhoto(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedPhoto = e.target.result;
                    document.getElementById('photoPreview').innerHTML = '<img src="' + uploadedPhoto + '" style="width:100%;border-radius:8px;margin-top:10px;"><p style="text-align:center;color:#667eea;margin-top:5px;">‚úÖ Photo charg√©e</p>';
                };
                reader.readAsDataURL(file);
            }
        }

        async function generate() {
            if (!apiKey) { alert('‚ö†Ô∏è Configurez votre API'); openModal(); return; }
            const loading = document.getElementById('loadingIndicator');
            const btn = document.getElementById('generateBtn');
            loading.style.display = 'block';
            btn.disabled = true;
            try {
                let prompt = '';
                if (currentTab === 'text') {
                    prompt = document.getElementById('textInput').value;
                    if (!prompt) { alert('‚ö†Ô∏è Entrez une description'); return; }
                } else if (currentTab === 'voice') {
                    prompt = 'Dessin cr√©atif bas√© sur audio';
                } else {
                    if (!uploadedPhoto) { alert('‚ö†Ô∏è T√©l√©chargez une photo'); return; }
                    prompt = 'Dessin inspir√© d\'image';
                }
                const instructions = await getInstructions(prompt);
                await drawAI(instructions);
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        async function getInstructions(prompt) {
            const res = await fetch('https://api.perplexity.ai/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'sonar-pro',
                    messages: [{ 
                        role: 'user', 
                        content: `Tu es un artiste professionnel qui cr√©e des dessins d√©taill√©s et r√©alistes. 
                        
Cr√©e des instructions de dessin TR√àS D√âTAILL√âES pour: "${prompt}"

IMPORTANT: Le dessin doit √™tre riche et artistique avec:
- 30 √† 80 √©l√©ments visuels (pas 5-10!)
- Des formes vari√©es et cr√©atives
- Des couleurs harmonieuses et r√©alistes
- Des d√©tails fins (yeux, bouche, textures, ombres)
- Une composition √©quilibr√©e sur le canvas 800x600

Types d'√©l√©ments disponibles:
1. "circle": {type:"circle", x, y, radius, color, fill:true/false, lineWidth}
2. "rectangle": {type:"rectangle", x, y, width, height, color, fill:true/false, lineWidth}
3. "line": {type:"line", x, y, x2, y2, color, lineWidth}
4. "arc": {type:"arc", x, y, radius, startAngle, endAngle, color, lineWidth}
5. "bezier": {type:"bezier", x, y, cp1x, cp1y, cp2x, cp2y, x2, y2, color, lineWidth}
6. "text": {type:"text", x, y, content, color, fontSize}

Exemples de d√©tails √† inclure:
- Pour un visage: contour, yeux (pupille+iris), sourcils, nez, bouche, oreilles, cheveux (plusieurs lignes)
- Pour un paysage: ciel, soleil/lune, nuages, arbres (tronc+feuilles), herbe, fleurs, oiseaux
- Pour un animal: corps principal, pattes, queue, t√™te, yeux, museau, oreilles, fourrure/plumes

R√©ponds UNIQUEMENT avec un tableau JSON valide, rien d'autre.` 
                    }],
                    temperature: 0.8,
                    max_tokens: 2500
                })
            });
            if (!res.ok) throw new Error('Erreur API');
            const data = await res.json();
            const content = data.choices[0].message.content;
            try {
                const match = content.match(/\[[\s\S]*\]/);
                if (match) return JSON.parse(match[0]);
                throw new Error('Format invalide');
            } catch (e) {
                console.error('Erreur parsing, utilisation fallback');
                return generateDetailedFallback(prompt);
            }
        }

        function generateDetailedFallback(prompt) {
            const lower = prompt.toLowerCase();
            if (lower.includes('soleil') || lower.includes('plage') || lower.includes('mer')) {
                return [
                    {type:'rectangle',x:0,y:0,width:800,height:300,color:'#87CEEB',fill:true},
                    {type:'circle',x:700,y:80,radius:50,color:'#FFD700',fill:true},
                    {type:'circle',x:700,y:80,radius:55,color:'#FFA500',fill:false,lineWidth:3},
                    {type:'rectangle',x:0,y:300,width:800,height:300,color:'#F4A460',fill:true},
                    {type:'line',x:0,y:300,x2:800,y2:300,color:'#8B4513',lineWidth:3},
                    {type:'bezier',x:50,y:320,cp1x:150,cp1y:280,cp2x:250,cp2y:340,x2:350,y2:300,color:'#4169E1',lineWidth:4},
                    {type:'bezier',x:400,y:310,cp1x:500,cp1y:270,cp2x:600,cp2y:330,x2:750,y2:290,color:'#4169E1',lineWidth:4},
                    {type:'line',x:100,y:400,x2:100,y2:500,color:'#8B4513',lineWidth:8},
                    {type:'circle',x:100,y:380,radius:40,color:'#228B22',fill:true},
                    {type:'circle',x:80,y:360,radius:25,color:'#32CD32',fill:true},
                    {type:'circle',x:120,y:365,radius:28,color:'#32CD32',fill:true},
                    {type:'line',x:250,y:420,x2:250,y2:510,color:'#8B4513',lineWidth:6},
                    {type:'circle',x:250,y:410,radius:35,color:'#228B22',fill:true},
                    {type:'circle',x:230,y:395,radius:22,color:'#32CD32',fill:true},
                    {type:'circle',x:270,y:400,radius:25,color:'#32CD32',fill:true},
                    {type:'circle',x:450,y:450,radius:8,color:'#FF69B4',fill:true},
                    {type:'circle',x:480,y:460,radius:8,color:'#FF1493',fill:true},
                    {type:'circle',x:520,y:455,radius:8,color:'#FF69B4',fill:true},
                    {type:'circle',x:350,y:470,radius:8,color:'#FFD700',fill:true},
                    {type:'circle',x:380,y:465,radius:8,color:'#FFA500',fill:true},
                    {type:'arc',x:200,y:100,radius:30,startAngle:0,endAngle:Math.PI,color:'#FFFFFF',lineWidth:3},
                    {type:'arc',x:280,y:120,radius:25,startAngle:0,endAngle:Math.PI,color:'#FFFFFF',lineWidth:3},
                    {type:'arc',x:350,y:90,radius:35,startAngle:0,endAngle:Math.PI,color:'#FFFFFF',lineWidth:3}
                ];
            }
            return [
                {type:'circle',x:400,y:250,radius:80,color:'#FFE4B5',fill:true},
                {type:'circle',x:370,y:230,radius:12,color:'#000000',fill:true},
                {type:'circle',x:430,y:230,radius:12,color:'#000000',fill:true},
                {type:'circle',x:372,y:228,radius:5,color:'#FFFFFF',fill:true},
                {type:'circle',x:432,y:228,radius:5,color:'#FFFFFF',fill:true},
                {type:'arc',x:365,y:215,radius:15,startAngle:Math.PI,endAngle:0,color:'#000000',lineWidth:2},
                {type:'arc',x:435,y:215,radius:15,startAngle:Math.PI,endAngle:0,color:'#000000',lineWidth:2},
                {type:'line',x:400,y:250,x2:400,y2:275,color:'#000000',lineWidth:2},
                {type:'arc',x:400,y:285,radius:25,startAngle:0.2,endAngle:Math.PI-0.2,color:'#FF6347',lineWidth:3},
                {type:'circle',x:340,y:240,radius:20,color:'#FFB6C1',fill:true},
                {type:'circle',x:460,y:240,radius:20,color:'#FFB6C1',fill:true},
                {type:'bezier',x:350,y:180,cp1x:370,cp1y:160,cp2x:380,cp2y:165,x2:400,y2:170,color:'#8B4513',lineWidth:3},
                {type:'bezier',x:400,y:170,cp1x:420,cp1y:165,cp2x:430,cp2y:160,x2:450,y2:180,color:'#8B4513',lineWidth:3}
            ];
        }

        async function drawAI(instructions) {
            clearCanvas();
            for (const inst of instructions) {
                ctx.strokeStyle = inst.color || '#000000';
                ctx.fillStyle = inst.color || '#000000';
                ctx.lineWidth = inst.lineWidth || 2;
                
                switch (inst.type) {
                    case 'circle':
                        ctx.beginPath();
                        ctx.arc(inst.x, inst.y, inst.radius, 0, Math.PI * 2);
                        if (inst.fill) ctx.fill(); else ctx.stroke();
                        break;
                    case 'rectangle':
                        if (inst.fill) ctx.fillRect(inst.x, inst.y, inst.width, inst.height);
                        else ctx.strokeRect(inst.x, inst.y, inst.width, inst.height);
                        break;
                    case 'line':
                        ctx.beginPath();
                        ctx.moveTo(inst.x, inst.y);
                        ctx.lineTo(inst.x2, inst.y2);
                        ctx.stroke();
                        break;
                    case 'arc':
                        ctx.beginPath();
                        ctx.arc(inst.x, inst.y, inst.radius, inst.startAngle, inst.endAngle);
                        ctx.stroke();
                        break;
                    case 'bezier':
                        ctx.beginPath();
                        ctx.moveTo(inst.x, inst.y);
                        ctx.bezierCurveTo(inst.cp1x, inst.cp1y, inst.cp2x, inst.cp2y, inst.x2, inst.y2);
                        ctx.stroke();
                        break;
                    case 'text':
                        ctx.font = (inst.fontSize || 20) + 'px Arial';
                        ctx.fillText(inst.content, inst.x, inst.y);
                        break;
                }
                await new Promise(r => setTimeout(r, 30));
            }
        }

        function openModal() {
            document.getElementById('apiModal').classList.add('show');
            document.getElementById('apiKeyInput').value = apiKey;
        }

        function closeModal() {
            document.getElementById('apiModal').classList.remove('show');
        }

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('perplexityApiKey', key);
                updateStatus();
                closeModal();
                alert('‚úÖ Cl√© enregistr√©e');
            } else {
                alert('‚ö†Ô∏è Cl√© invalide');
            }
        }

        function updateStatus() {
            const status = document.getElementById('apiStatus');
            if (apiKey) {
                status.className = 'api-status connected';
                status.textContent = '‚úÖ API connect√©e';
            } else {
                status.className = 'api-status disconnected';
                status.textContent = '‚ö†Ô∏è API non configur√©e';
            }
        }

        function saveDrawing() {
            const title = prompt('Titre:');
            if (!title) return;
            const drawing = { id: Date.now(), title: title, image: canvas.toDataURL(), date: new Date().toLocaleDateString('fr-FR') };
            drawings.unshift(drawing);
            localStorage.setItem('drawings', JSON.stringify(drawings));
            loadGallery();
        }

        function download() {
            const link = document.createElement('a');
            link.download = 'draw-' + Date.now() + '.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        function loadGallery() {
            drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
            const gallery = document.getElementById('gallery');
            if (drawings.length === 0) {
                gallery.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Aucun dessin</p>';
                return;
            }
            gallery.innerHTML = drawings.map(d => '<div class="gallery-item"><img src="' + d.image + '" class="gallery-img"><div class="gallery-info"><strong>' + d.title + '</strong><div class="gallery-actions"><span style="font-size:0.85em;color:#666;">' + d.date + '</span><button class="delete-btn" onclick="deleteDraw(' + d.id + ')">üóëÔ∏è</button></div></div></div>').join('');
        }

        function deleteDraw(id) {
            if (confirm('Supprimer?')) {
                drawings = drawings.filter(d => d.id !== id);
                localStorage.setItem('drawings', JSON.stringify(drawings));
                loadGallery();
            }
        }
    </script>
</body>
</html>